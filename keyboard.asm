%define KBD_CTRL_DATA_PORT             0x60     ; Keyboard controller ports
%define KBD_CTRL_STATUS_PORT           0x64
%define KBD_CTRL_COMMAND_PORT          0x64

%define KBD_CTRL_STATUS_PARITY         0x80     ; Keyboard controller status mask
%define KBD_CTRL_STATUS_TIMEOUT        0x40
%define KBD_CTRL_STATUS_AUX_BUF        0x20
%define KBD_CTRL_STATUS_LOCKED         0x10
%define KBD_CTRL_STATUS_CMD_DATA       0x08
%define KBD_CTRL_STATUS_SYSTEM         0x04
%define KBD_CTRL_STATUS_IN_BUF         0x02
%define KBD_CTRL_STATUS_OUT_BUF        0x01

%define KBD_CTRL_CMD_READ              0x20     ; Common keyboard controller commands
%define KBD_CTRL_CMD_WRITE             0x60
%define KBD_CTRL_CMD_SELF_TEST         0xaa
%define KBD_CTRL_CMD_INTERFACE_TEST    0xab
%define KBD_CTRL_CMD_DISABLE           0xad
%define KBD_CTRL_CMD_ENABLE            0xae
%define KBD_CTRL_CMD_READ_IN_PORT      0xc0
%define KBD_CTRL_CMD_READ_OUT_PORT     0xd0
%define KBD_CTRL_CMD_WRITE_OUT_PORT    0xd1
%define KBD_CTRL_CMD_READ_TEST_INPUTS  0xe0
%define KBD_CTRL_CMD_SYSTEM_RESET      0xfe
%define KBD_CTRL_CMD_MOUSE_DISABLE     0xa7
%define KBD_CTRL_CMD_MOUSE_ENABLE      0xa8
%define KBD_CTRL_CMD_MOUSE_PORT_TEST   0xa9
%define KBD_CTRL_CMD_MOUSE_WRITE       0xd4 
    
%define PIC_MASTER_COMMAND             0x20
%define PIC_MASTER_DATA                0x21
%define PIC_SLAVE_COMMAND              0xa0
%define PIC_SLAVE_DATA                 0xa1

%define KBD_ENC_INPUT_BUF              0x60     ; Keyboard encoder commands
%define KBD_ENC_CMD_REG                0x60
%define KBD_ENC_CMD_SET_LED            0xed
%define KBD_ENC_CMD_ECHO               0xee
%define KBD_ENC_CMD_SCAN_CODE_SET      0xf0
%define KBD_ENC_CMD_ID                 0xf2
%define KBD_ENC_CMD_AUTODELAY          0xf3
%define KBD_ENC_CMD_ENABLE             0xf4
%define KBD_ENC_CMD_RESETWAIT          0xf5
%define KBD_ENC_CMD_RESETSCAN          0xf6
%define KBD_ENC_CMD_ALL_AUTO           0xf7
%define KBD_ENC_CMD_ALL_MAKEBREAK      0xf8
%define KBD_ENC_CMD_ALL_MAKEONLY       0xf9
%define KBD_ENC_CMD_ALL_MAKEBREAK_AUTO 0xfa
%define KBD_ENC_CMD_SINGLE_AUTOREPEAT  0xfb
%define KBD_ENC_CMD_SINGLE_MAKEBREAK   0xfc
%define KBD_ENC_CMD_SINGLE_BREAKONLY   0xfd
%define KBD_ENC_CMD_RESEND             0xfe
%define KBD_ENC_CMD_RESET              0xff
%define IO_DELAY nop

%define KBD_FLAGS_INSERT_MASK          0x80     ; Bit 7 = insert on
%define KBD_FLAGS_CAPS_MASK            0x40     ; Bit 6 = caps lock on
%define KBD_FLAGS_NUM_MASK             0x20     ; Bit 5 = num lock on
%define KBD_FLAGS_SCROLL_MASK          0x10     ; Bit 4 = scroll lock on
%define KBD_FLAGS_ALT_MASK             0x08     ; Bit 3 = alt key down
%define KBD_FLAGS_CTRL_MASK            0x04     ; Bit 2 = ctrl key down
%define KBD_FLAGS_RSHIFT_MASK          0x02     ; Bit 1 = left shift down
%define KBD_FLAGS_LSHIFT_MASK          0x01     ; Bit 0 = right shift down

kbdScanCodeTable db 0x00, 0x1b, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36
                 db 0x37, 0x38, 0x39, 0x30, 0x2d, 0x3d, 0x08, 0x09
                 db 0x71, 0x77, 0x65, 0x72, 0x74, 0x79, 0x75, 0x69
                 db 0x6f, 0x70, 0x5b, 0x5d, 0x0d, 0x00, 0x61, 0x73
                 db 0x64, 0x66, 0x67, 0x68, 0x6a, 0x6b, 0x6c, 0x3b
                 db 0x27, 0x60, 0x00, 0x5c, 0x7a, 0x78, 0x63, 0x76
                 db 0x62, 0x6e, 0x6d, 0x2c, 0x2e, 0x2f, 0x00, 0x2a
                 db 0x00, 0x20, 0x00, 0x0f, 0x10, 0x11, 0x12, 0x13
                 db 0x14, 0x15, 0x16, 0x17, 0x18, 0x00, 0x00, 0x86
                 db 0x81, 0x85, 0xad, 0x83, 0x9f, 0x84, 0xab, 0x8b
                 db 0x82, 0x8c, 0x8e, 0xff, 0x1c, 0x00, 0x00, 0x19
                 db 0x1a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x0e, 0x0b, 0x02, 0x0c, 0x03, 0x00, 0x04, 0x06
                 db 0x01, 0x05, 0x7f, 0xaf, 0x8d, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    
kbdCtrlTable     db 0x00, 0x1b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e
                 db 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x7f, 0x0f
                 db 0x11, 0x17, 0x05, 0x00, 0x00, 0x19, 0x15, 0x09
                 db 0x0f, 0x10, 0x1b, 0x1d, 0x0a, 0x00, 0x01, 0x13
                 db 0x04, 0x06, 0x07, 0x08, 0x0a, 0x0b, 0x0c, 0x00
                 db 0x00, 0x00, 0x00, 0x1c, 0x1a, 0x18, 0x03, 0x16
                 db 0x02, 0x0e, 0x0d, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x00, 0x20, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0
                 db 0x00, 0x00, 0x7a, 0x7b, 0x7c, 0x7d, 0x7e, 0x7f
                 db 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00
                 db 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00
                 db 0x00, 0xe0, 0x0e, 0x0e, 0x00, 0x00, 0x00, 0x00
                 db 0x00
    
kbdShiftTable    db 0x00, 0x38, 0x32, 0x34, 0x36, 0x39, 0x37, 0x07
                 db 0x08, 0x09, 0x0a, 0x31, 0x33, 0x0d, 0x30, 0x0f
                 db 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17
                 db 0x18, 0x18, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x35
                 db 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x22
                 db 0x28, 0x29, 0x2a, 0x2b, 0x3c, 0x5f, 0x3e, 0x3f
                 db 0x29, 0x21, 0x40, 0x23, 0x24, 0x25, 0x5e, 0x26
                 db 0x2a, 0x28, 0x3a, 0x3a, 0x3c, 0x2b, 0x3e, 0x3f
                 db 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47
                 db 0x48, 0x49, 0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f
                 db 0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57
                 db 0x58, 0x59, 0x5a, 0x7b, 0x7c, 0x7d, 0x5e, 0x5f
                 db 0x7e, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47
                 db 0x48, 0x49, 0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f
                 db 0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57
                 db 0x58, 0x59, 0x5a, 0x7b, 0x7c, 0x7d, 0x7e, 0x2e

      lastKey dw 0
      kbdFlags  db 0

  ;; --------------------------------
  setupKbdCtrl

      push ax
      push es
